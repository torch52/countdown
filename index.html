<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸Šç­å›‰!</title>
  <style>
    :root{
      --bg: #f2f1f0;
      --card: #f9f7f6;
      --accent: #bbafa4;
      --muted: #6a5f58;
      --text: #3e3a36;
      --btn-text: #fff;
    }
    /* å…¨åŸŸ */
    *{box-sizing:border-box}
    body{
      margin:0; font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; padding:14px 18px;
      background:linear-gradient(90deg,var(--card),var(--bg));
      border-bottom:1px solid rgba(0,0,0,0.04);
    }
    header h1{margin:0;font-size:1.15rem}
    #date{font-size:0.9rem;color:var(--muted)}

    main{max-width:920px;margin:18px auto;padding:16px;display:flex;gap:18px;align-items:flex-start;}
    /* å·¦å€å¡Šï¼ˆç°½åˆ°ï¼‰*/
    .left{flex:1; background:var(--card); padding:14px;border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="text"], input[type="time"], select {
      padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); font-size:0.95rem;
      background: #fff;
    }
    button { padding:8px 10px; border-radius:8px; border:none; background:var(--accent); color:var(--btn-text); cursor:pointer; font-size:0.95rem;}
    button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.06)}
    #list{margin-top:12px}
    .person{display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; margin-bottom:8px; background:rgba(255,255,255,0.85); border:1px solid rgba(0,0,0,0.02)}
    .person .leftInfo{display:flex; gap:12px; align-items:center;}
    .pname{font-weight:700}
    .ptime{font-size:0.9rem; color:var(--muted)}
    .countdown{font-weight:700; color:var(--muted)}
    .adminBtns button{margin-left:6px; padding:6px 8px; font-size:0.8rem}

    /* å³å€å¡Šï¼ˆæ¯æ—¥ / å¹¸é‹è‰² / ç¬‘è©±ï¼‰*/
    .right{width:300px; background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .card{margin-bottom:12px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.9)}
    .colorChip{display:inline-flex;align-items:center;gap:8px;margin-top:6px}
    .swatch{width:28px;height:20px;border-radius:4px;border:1px solid rgba(0,0,0,0.06);display:inline-block;vertical-align:middle}

    /* ä¸»é¡Œé¸å–® */
    .themeSel{margin-left:8px}

    /* é½’è¼ªï¼ˆç®¡ç†ï¼‰*/
    #gear{width:36px;height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;background:transparent; border:1px solid rgba(0,0,0,0.04)}
    #gear svg{width:20px;height:20px; fill:var(--muted)}
    /* å¯†ç¢¼ modal */
    .modalBg{position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:60}
    .modal{background:var(--card); padding:16px;border-radius:10px; width:320px; box-shadow:0 8px 24px rgba(0,0,0,0.2)}
    .modal input{width:100%; margin-top:8px}

    /* ç•™è¨€æ¿ï¼ˆå³ä¸‹å½ˆå‡ºï¼‰*/
    #msgButton{
      position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%;
      background:var(--accent); color:var(--btn-text); display:flex;align-items:center;justify-content:center; cursor:pointer; z-index:55; box-shadow:0 8px 20px rgba(0,0,0,0.12)
    }
    #msgPanel{position:fixed; right:18px; bottom:86px; width:340px; max-height:68vh; background:var(--card); border-radius:10px; box-shadow:0 12px 36px rgba(0,0,0,0.18); padding:10px; display:none; flex-direction:column; z-index:55}
    #msgPanel header{display:flex; justify-content:space-between; align-items:center; gap:8px}
    #msgList{overflow:auto; max-height:46vh; margin-top:10px}
    .msgItem{padding:8px; border-radius:8px; margin-bottom:8px; background:rgba(255,255,255,0.92); border:1px solid rgba(0,0,0,0.04); position:relative}
    .msgItem time{display:block;font-size:0.75rem;color:var(--muted); margin-top:6px}
    .msgControls{position:absolute; top:6px; right:8px}
    .msgControls button{background:transparent;border:none;color:var(--muted); cursor:pointer; font-size:0.85rem}

    /* å°æé†’ / å½ˆçª—æ¨£å¼ */
    .toast{position:fixed; left:50%; transform:translateX(-50%); top:22px; background:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 8px 26px rgba(0,0,0,0.14); display:none; z-index:70}

    /* å›æ‡‰å¼ */
    @media(max-width:880px){
      main{flex-direction:column;padding:12px}
      .right{width:100%}
      #msgPanel{right:12px; left:12px; width:auto}
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>ä¸Šç­å›‰!</h1>
      <div id="date">è¼‰å…¥æ—¥æœŸ...</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px">
      <label for="themeSelect" style="color:var(--muted)">ä¸»é¡Œ</label>
      <select id="themeSelect" class="themeSel" title="åˆ‡æ›ä¸»é¡Œ"></select>
      <div id="gear" title="ç®¡ç†å“¡è¨­å®š (é»æ“Šè¼¸å…¥å¯†ç¢¼)">
        <!-- simple gear icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14,12.94a7.14,7.14,0,0,0,0-1.88l2.03-1.58a0.5,0.5,0,0,0,.12-0.64l-1.92-3.32a0.5,0.5,0,0,0-.6-0.22l-2.39,0.96a7.05,7.05,0,0,0-1.62-0.94L14.8,2.5a0.5,0.5,0,0,0-.5-0.5H10a0.5,0.5,0,0,0-.5.5L9,4.2a7.05,7.05,0,0,0-1.62.94L4.96,4.2a0.5,0.5,0,0,0-.6.22L2.44,7.74a0.5,0.5,0,0,0,.12.64L4.59,10a7.14,7.14,0,0,0,0,1.88L2.56,13.46a0.5,0.5,0,0,0-.12.64l1.92,3.32a0.5,0.5,0,0,0,.6.22l2.39-0.96a7.05,7.05,0,0,0,1.62.94L9.5,21.5a0.5,0.5,0,0,0,.5.5h4.3a0.5,0.5,0,0,0,.5-0.5l0.12-2.12a7.05,7.05,0,0,0,1.62-.94l2.39,0.96a0.5,0.5,0,0,0,.6-0.22l1.92-3.32a0.5,0.5,0,0,0-.12-0.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
      </div>
    </div>
  </header>

  <main>
    <section class="left">
      <div class="controls">
        <input id="nameInput" type="text" placeholder="è«‹è¼¸å…¥å§“å"/>
        <input id="timeInput" type="time" />
        <button id="checkinBtn">ç°½åˆ° / æ›´æ–°ä¸Šç­æ™‚é–“</button>
        <button id="refreshBtn" class="ghost" title="é‡æ–°æ•´ç†é¡¯ç¤º">é‡æ–°æ•´ç†</button>
      </div>

      <div id="list"></div>
    </section>

    <aside class="right">
      <div class="card">
        <div><strong>ä»Šæ—¥ç¬‘è©± / Joke of the day</strong></div>
        <div id="jokeZh" style="margin-top:8px;color:var(--muted)">è¼‰å…¥ä¸­â€¦</div>
        <div id="jokeEn" style="margin-top:6px;font-size:0.95rem;color:#556">loading...</div>
      </div>

      <div class="card">
        <div><strong>ä»Šæ—¥å¹¸é‹è‰²</strong></div>
        <div style="margin-top:8px">
          <div>â™ å¤©è ï¼š <span id="scorpioName" class="ptime"></span> <span class="swatch" id="scorpioSw"></span></div>
          <div style="margin-top:6px">â™‘ æ‘©ç¾¯ï¼š <span id="capricornName" class="ptime"></span> <span class="swatch" id="capricornSw"></span></div>
        </div>
      
      </div>
    </aside>
  </main>

  <!-- ç•™è¨€æŒ‰éˆ•èˆ‡é¢æ¿ -->
  <div id="msgButton" title="ç•™è¨€æ¿">ğŸ’¬</div>
  <div id="msgPanel">
    <header>
      <strong>ç•™è¨€æ¿</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="msgName" type="text" placeholder="ä½ çš„åå­—" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"/>
      </div>
    </header>
    <div id="msgList"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="msgInput" type="text" placeholder="è¼¸å…¥ç•™è¨€..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
      <button id="msgSend">é€å‡º</button>
    </div>
  </div>

  <!-- å¯†ç¢¼ modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <div style="font-weight:700">ç®¡ç†å“¡ç™»å…¥</div>
      <div style="margin-top:8px;color:var(--muted)">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š</div>
      <input id="adminPwd" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼"/>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="adminCancel" class="ghost">å–æ¶ˆ</button>
        <button id="adminSubmit">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ---------- Firebase init ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB8lK1b6nx2hunGNwHutpBCO-BeKO5XntQ",
      authDomain: "countdown-11b34.firebaseapp.com",
      databaseURL: "https://countdown-11b34-default-rtdb.firebaseio.com",
      projectId: "countdown-11b34",
      storageBucket: "countdown-11b34.firebasestorage.app",
      messagingSenderId: "338264464503",
      appId: "1:338264464503:web:507ef5a71113162a91fa72",
      measurementId: "G-TE12G16JLZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- Config ----------
    const ADMIN_PASSWORD = "Pam3CSK4"; // you requested
    let isAdmin = false;

    // ---------- DOM ----------
    const dateEl = document.getElementById('date');
    const themeSelect = document.getElementById('themeSelect');
    const nameInput = document.getElementById('nameInput');
    const timeInput = document.getElementById('timeInput');
    const checkinBtn = document.getElementById('checkinBtn');
    const listEl = document.getElementById('list');
    const refreshBtn = document.getElementById('refreshBtn');

    const jokeZhEl = document.getElementById('jokeZh');
    const jokeEnEl = document.getElementById('jokeEn');

    const scorpioNameEl = document.getElementById('scorpioName');
    const scorpioSwEl = document.getElementById('scorpioSw');
    const capricornNameEl = document.getElementById('capricornName');
    const capricornSwEl = document.getElementById('capricornSw');

    // msg panel
    const msgButton = document.getElementById('msgButton');
    const msgPanel = document.getElementById('msgPanel');
    const msgList = document.getElementById('msgList');
    const msgInput = document.getElementById('msgInput');
    const msgSend = document.getElementById('msgSend');
    const msgName = document.getElementById('msgName');

    // modal
    const gear = document.getElementById('gear');
    const modalBg = document.getElementById('modalBg');
    const adminPwd = document.getElementById('adminPwd');
    const adminSubmit = document.getElementById('adminSubmit');
    const adminCancel = document.getElementById('adminCancel');

    const toast = document.getElementById('toast');

    // ---------- Utility ----------
    function showToast(text, timeout=2800){
      toast.textContent = text;
      toast.style.display = 'block';
      setTimeout(()=>toast.style.display='none', timeout);
    }

    function pad(n){ return n.toString().padStart(2,'0'); }

    // ---------- Date display ----------
    function renderDate(){
      const d = new Date();
      const dateStr = d.toLocaleDateString('zh-TW', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
      dateEl.textContent = `ğŸ“… ${dateStr}`;
    }
    renderDate();

    // ---------- Themes (5 Mo rand i-like palettes) ----------
    const THEMES = [
      {name:'æ™¨éœ§ç±³ (å¥¶èŒ¶ç³»)', vars:{'--bg':'#f3f2ef','--card':'#f9f7f5','--accent':'#bfb1a6','--muted':'#6e6158','--text':'#3e3a36'}},
      {name:'éœ§è—ç¶ ', vars:{'--bg':'#eef1f0','--card':'#f6f8f7','--accent':'#aebdb6','--muted':'#5f6b66','--text':'#39413f'}},
      {name:'è—•ç²‰ç°', vars:{'--bg':'#f6f4f5','--card':'#fbf8f8','--accent':'#c8b3b8','--muted':'#6a5b60','--text':'#3d3336'}},
      {name:'æ·ºå¡å…¶ç¶ ', vars:{'--bg':'#f4f6f4','--card':'#fbfcfb','--accent':'#bfc7b8','--muted':'#656b60','--text':'#344031'}},
      {name:'çŸ³ç°ç™½è—', vars:{'--bg':'#f1f3f4','--card':'#fbfbfc','--accent':'#b9c0c6','--muted':'#615e61','--text':'#333538'}}
    ];

    function loadThemeOptions(){
      THEMES.forEach((t, i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = t.name;
        themeSelect.appendChild(opt);
      });
      // load from localStorage
      const saved = localStorage.getItem('wb_theme');
      const idx = saved !== null ? Number(saved) : 0;
      themeSelect.value = idx;
      applyTheme(idx);
    }
    function applyTheme(idx){
      const t = THEMES[idx] || THEMES[0];
      Object.entries(t.vars).forEach(([k,v])=>document.documentElement.style.setProperty(k, v));
      localStorage.setItem('wb_theme', idx);
    }
    themeSelect.addEventListener('change', ()=>applyTheme(themeSelect.value));
    loadThemeOptions();

    // ---------- Jokes (zh + en) ----------
    const JOKES = [
      {zh:'æ˜¨å¤©åŠ ç­å¤ªä¹…ï¼Œé€£å¤¢éƒ½åœ¨é–‹æœƒã€‚', en:"Worked overtime yesterday â€” even my dreams had meetings."},
      {zh:'åˆä¼‘å¤ªçŸ­ï¼Œå¤¢éƒ½ä¾†ä¸åŠç™¼å±•ã€‚', en:"Lunch break too short â€” my dreams didn't have time to develop."},
      {zh:'é–‹å®Œæœƒåˆé–‹æœƒï¼Œæœƒä¸æœƒé–‹å‡ºæ–°äººç”Ÿï¼Ÿ', en:"After one meeting, another meeting â€” will a new life emerge from all these meetings?"},
      {zh:'åˆ¥æ‡·ç–‘ï¼Œä»Šå¤©ä¹Ÿæ˜¯é©åˆå·æ‡¶çš„ä¸€å¤©ã€‚', en:"Don't doubt it â€” today is another day fit for a little slacking."},
      {zh:'å’–å•¡ + å¾®ç¬‘ = è·å ´ç”Ÿå­˜å…¬å¼ã€‚', en:"Coffee + smile = the workplace survival formula."},
      {zh:'ä½ çš„ç¬‘å®¹æ¯”è€é—†çš„è®šç¾æ›´èƒ½æ’éæ˜ŸæœŸä¸€ï¼', en:"Your smile beats the boss's praise for surviving Monday."},
      {zh:'æ—©èµ·ä¸æ˜¯å¤¢ï¼Œåªæ˜¯é¬§é˜å¤ªå…‡ã€‚', en:"Waking up early isn't a dream â€” it's just that the alarm is too fierce."},
      {zh:'åŠªåŠ›ä¸Šç­åªæ˜¯ç‚ºäº†ä¸‹ç­æ›´ç†ç›´æ°£å£¯ã€‚', en:"We work hard so we can leave work with a clear conscience."}
    ];
    function showDailyJoke(){
      const day = new Date().getDate();
      const j = JOKES[day % JOKES.length];
      jokeZhEl.textContent = "ğŸ¤ª " + j.zh;
      jokeEnEl.textContent = "ğŸ™‚ " + j.en;
    }
    showDailyJoke();

    // ---------- Lucky colors (any colors allowed, not limited to Morandi) ----------
    // each entry: {name, hex}
    const SCORPIO_COLORS = [
      {name:'è±¡ç‰™ç™½', hex:'#F6F3ED'},
      {name:'å¤œéœ§ç´«', hex:'#6E5673'},
      {name:'æ·±æµ·çŸ³æ¿', hex:'#3C556E'},
      {name:'å¥¶éœœç°', hex:'#DCD7D0'},
      {name:'å¢¨è—', hex:'#23394B'},
      {name:'è‘¡è„é…’ç´…', hex:'#7A2F3F'}
    ];
    const CAPRICORN_COLORS = [
      {name:'éœ§è—ç°', hex:'#A7B1AD'},
      {name:'ç ‚å²©è¤', hex:'#A8937B'},
      {name:'æ·±çŸ³æ¿', hex:'#556066'},
      {name:'è±¡ç‰™ç™½', hex:'#FBF7F2'},
      {name:'æ¾ç¶ ', hex:'#6B7A6F'},
      {name:'æ™¨éœ§ç°', hex:'#CFC7C1'}
    ];
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function showLuckyColors(){
      const sc = pickRandom(SCORPIO_COLORS);
      const cp = pickRandom(CAPRICORN_COLORS);
      scorpioNameEl.textContent = `${sc.name} (${sc.hex})`;
      scorpioSwEl.style.background = sc.hex;
      scorpioSwEl.title = sc.name + ' ' + sc.hex;

      capricornNameEl.textContent = `${cp.name} (${cp.hex})`;
      capricornSwEl.style.background = cp.hex;
      capricornSwEl.title = cp.name + ' ' + cp.hex;
    }
    showLuckyColors();

    // ---------- Birthdays & Valentine's popups ----------
    // We'll show popup if today's month-day matches any of these:
    const SPECIAL_DATES = {
      // month-day : message
      '11-14': 'ğŸ‚ ç¥ å©·å¦ƒ ç”Ÿæ—¥å¿«æ¨‚ï¼ç”Ÿæ—¥å¿«æ¨‚ï¼Œå©·å¦ƒï½ ğŸ’–',
      '12-29': 'ğŸ‰ ç¥ Allen ç”Ÿæ—¥å¿«æ¨‚ï¼ç”Ÿæ—¥å¿«æ¨‚ï¼ŒAllenï½ ğŸ‚',
      '02-14': 'ğŸ’˜ æƒ…äººç¯€å¿«æ¨‚ï¼Happy Valentine\'s Day!',
      '05-20': 'ğŸ’˜ 520 æƒ…äººç¯€å¿«æ¨‚ï¼' // user requested "æ¯å€‹æƒ…äººç¯€ç•¶å¤©éƒ½é¡¯ç¤º" - we include 5/20 too
      // Note: ä¸ƒå¤• (è¾²æ›†) è‹¥è¦æ”¯æ´éœ€é¡å¤– lunar conversion
    };
    function checkSpecialDay(){
      const d = new Date();
      const key = pad(d.getMonth()+1) + '-' + pad(d.getDate());
      if(SPECIAL_DATES[key]){
        setTimeout(()=>showModalToast(SPECIAL_DATES[key]), 600);
      }
    }
    function showModalToast(text){
      // reuse toast but keep slightly longer and show prominently
      toast.textContent = text;
      toast.style.display = 'block';
      setTimeout(()=>toast.style.display='none', 6500);
    }
    checkSpecialDay();

    // ---------- Sign-in / Checkin logic ----------
    // save name to localStorage for convenience
    const savedName = localStorage.getItem('wb_name');
    if(savedName) nameInput.value = savedName;
    nameInput.addEventListener('input', ()=>localStorage.setItem('wb_name', nameInput.value.trim()));

    // default timeInput to current time
    function setTimeToNow(){
      const d = new Date();
      timeInput.value = pad(d.getHours()) + ':' + pad(d.getMinutes());
    }
    setTimeToNow();

    checkinBtn.addEventListener('click', ()=> {
      const name = nameInput.value.trim();
      const t = timeInput.value;
      if(!name) return alert('è«‹è¼¸å…¥å§“å');
      if(!t) return alert('è«‹é¸æ“‡ä¸Šç­æ™‚é–“');
      const key = name.replace(/\s+/g,'_');
      // compute end time = t + 9 hours (in today's date)
      const parts = t.split(':').map(x=>Number(x));
      const now = new Date();
      const startDt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parts[0], parts[1], 0, 0);
      const endDt = new Date(startDt.getTime() + 9*3600*1000);
      db.ref('checkin/'+key).set({
        name,
        start: startDt.getTime(),
        end: endDt.getTime(),
        timestamp: Date.now()
      }).then(()=> {
        showToast('ç°½åˆ°å·²è¨˜éŒ„');
      }).catch(err=>console.error(err));
    });

    // render checkins from firebase
    let currentCheckins = {};
    db.ref('checkin').on('value', snap=> {
      currentCheckins = snap.val() || {};
      renderCheckins();
    });

    function renderCheckins(){
      listEl.innerHTML = '';
      const arr = Object.entries(currentCheckins).map(([k,v])=>({key:k, ...v}));
      arr.sort((a,b)=> a.name.localeCompare(b.name, 'zh-Hant'));
      arr.forEach(item => {
        const el = document.createElement('div');
        el.className = 'person';
        const start = new Date(Number(item.start));
        const end = new Date(Number(item.end));
        const startStr = start.toLocaleTimeString('zh-TW',{hour12:false});
        const endStr = end.toLocaleTimeString('zh-TW',{hour12:false});
        el.innerHTML = `
          <div class="leftInfo">
            <div>
              <div class="pname">${item.name}</div>
              <div class="ptime">ä¸Šç­ ${startStr} ï½œ ä¸‹ç­ ${endStr}</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end">
            <div class="countdown" data-end="${item.end}" id="cd_${item.key}">--:--:--</div>
            <div class="adminBtns"></div>
          </div>
        `;
        // admin buttons (shown only when isAdmin)
        const adminBtns = el.querySelector('.adminBtns');
        if(isAdmin){
          const del = document.createElement('button'); del.textContent='åˆªé™¤'; del.style.background='#e08c8c';
          del.onclick = ()=> {
            if(confirm(`ç¢ºå®šåˆªé™¤ ${item.name} çš„ç°½åˆ°ç´€éŒ„ï¼Ÿ`)) db.ref('checkin/'+item.key).remove();
          };
          const edit = document.createElement('button'); edit.textContent='ç·¨è¼¯'; edit.style.background='#bbb';
          edit.onclick = ()=> {
            // edit name and/or start time
            const newName = prompt('ä¿®æ”¹å§“åï¼š', item.name);
            if(newName===null) return;
            const newTime = prompt('ä¿®æ”¹ä¸Šç­æ™‚é–“ (HH:mm)ï¼š', startStr);
            if(newTime===null) return;
            const parts = newTime.split(':').map(x=>Number(x));
            const dtStart = new Date(Number(item.start));
            dtStart.setHours(parts[0], parts[1], 0, 0);
            const dtEnd = new Date(dtStart.getTime() + 9*3600*1000);
            const newKey = newName.replace(/\s+/g,'_');
            // update: if key changed, remove old and set new
            const payload = {name:newName, start: dtStart.getTime(), end: dtEnd.getTime(), timestamp: Date.now()};
            // if key changed
            if(newKey !== item.key){
              db.ref('checkin/'+newKey).set(payload).then(()=> db.ref('checkin/'+item.key).remove());
            } else {
              db.ref('checkin/'+item.key).set(payload);
            }
          };
          adminBtns.appendChild(edit); adminBtns.appendChild(del);
        }
        listEl.appendChild(el);
      });
    }

    // countdown updater
    setInterval(()=>{
      document.querySelectorAll('.countdown').forEach(el=>{
        const end = Number(el.dataset.end);
        if(!end) { el.textContent='--:--:--'; return; }
        const diff = end - Date.now();
        if(diff <= 0){
          el.textContent = 'å·²ä¸‹ç­';
          // do not auto-remove unless admin wants
        } else {
          const H = Math.floor(diff/3600000);
          const M = Math.floor(diff%3600000/60000);
          const S = Math.floor(diff%60000/1000);
          el.textContent = `${pad(H)}:${pad(M)}:${pad(S)}`;
        }
      });
    }, 1000);

    refreshBtn.addEventListener('click', ()=> renderCheckins());

    // ---------- Messages (Firebase) ----------
    msgButton.addEventListener('click', ()=> {
      msgPanel.style.display = msgPanel.style.display === 'flex' ? 'none' : 'flex';
    });

    msgSend.addEventListener('click', ()=> {
      const text = msgInput.value.trim();
      if(!text) return;
      const who = (msgName.value || nameInput.value || 'åŒ¿å').trim();
      const entryRef = db.ref('messages').push();
      entryRef.set({
        name: who,
        text,
        time: Date.now()
      }).then(()=>{
        msgInput.value = '';
        showToast('ç•™è¨€å·²é€å‡º');
      });
    });

    let currentMsgs = {};
    db.ref('messages').on('value', snap=>{
      currentMsgs = snap.val() || {};
      renderMsgs();
    });

    function renderMsgs(){
      msgList.innerHTML = '';
      // convert to array and sort newest first
      const arr = Object.entries(currentMsgs).map(([k,v])=>({k,...v}));
      arr.sort((a,b)=> b.time - a.time);
      arr.forEach(obj=>{
        const div = document.createElement('div');
        div.className = 'msgItem';
        const t = new Date(obj.time).toLocaleString('zh-TW', {hour12:false});
        div.innerHTML = `<div><strong>${escapeHtml(obj.name)}</strong></div>
                         <div style="margin-top:6px">${escapeHtml(obj.text)}</div>
                         <time>${t}</time>`;
        if(isAdmin){
          const ctrl = document.createElement('div'); ctrl.className='msgControls';
          const editBtn = document.createElement('button'); editBtn.innerText='ç·¨è¼¯';
          editBtn.onclick = ()=> {
            const newText = prompt('ç·¨è¼¯ç•™è¨€å…§å®¹ï¼š', obj.text);
            if(newText !== null) db.ref('messages/'+obj.k+'/text').set(newText);
          };
          const delBtn = document.createElement('button'); delBtn.innerText='åˆªé™¤';
          delBtn.onclick = ()=> {
            if(confirm('ç¢ºå®šåˆªé™¤ç•™è¨€ï¼Ÿ')) db.ref('messages/'+obj.k).remove();
          };
          ctrl.appendChild(editBtn); ctrl.appendChild(delBtn);
          div.appendChild(ctrl);
        }
        msgList.appendChild(div);
      });
    }

    // simple HTML escaper to avoid injection
    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // admin modal handling
    gear.addEventListener('click', ()=> {
      modalBg.style.display = 'flex';
      adminPwd.value = '';
      adminPwd.focus();
    });
    adminCancel.addEventListener('click', ()=> modalBg.style.display = 'none');

    adminSubmit.addEventListener('click', ()=> {
      const val = adminPwd.value;
      if(val === ADMIN_PASSWORD){
        isAdmin = true;
        modalBg.style.display = 'none';
        showToast('ç®¡ç†å“¡å·²ç™»å…¥');
        renderCheckins();
        renderMsgs();
      } else {
        alert('å¯†ç¢¼éŒ¯èª¤');
      }
    });

    // allow pressing Enter in pwd
    adminPwd.addEventListener('keydown', (e)=> { if(e.key === 'Enter') adminSubmit.click(); });

    // ---------- Admin persistence: toggle logout on reload? ----------
    // We'll remember admin in session only
    // If want to persist, set sessionStorage flag
    // For now, remember for the session
    window.addEventListener('beforeunload', ()=>{ /* nothing */ });

    // ---------- Startup: populate theme select, jokes, lucky colors done above ----------
    // show initial data
    renderCheckins();
    renderMsgs();

    // ---------- Utility: show daily birthday check again on load (already called above) ----------
    // also update lucky color and joke every day if user leaves page open
    setInterval(()=> {
      const now = new Date();
      // if midnight passed, update daily items
      // simple check: if hour==0 and minute==0 (runs near midnight) update
      if(now.getHours()===0 && now.getMinutes()===0){
        showDailyJoke();
        showLuckyColors();
        renderDate();
        checkSpecialDay();
      }
    }, 60000);

  </script>
</body>
</html>
